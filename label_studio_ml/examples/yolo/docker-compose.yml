version: "3.8"

services:
  yolo:
    container_name: yolo-ml-backend
    image: yolo-ml-backend:latest
    build:
      context: .
      args:
        TEST_ENV: ${TEST_ENV:-false}
        USE_HYBRID_MODE: ${USE_HYBRID_MODE:-false}
    environment:
      # Core configuration - EDIT THESE VALUES
      - LABEL_STUDIO_HOST=${LABEL_STUDIO_HOST:-http://host.docker.internal:8080}
      - LABEL_STUDIO_API_KEY=${LABEL_STUDIO_API_KEY}

      # Optional authentication
      - BASIC_AUTH_USER=${BASIC_AUTH_USER:-}
      - BASIC_AUTH_PASS=${BASIC_AUTH_PASS:-}

      # Logging and performance
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - WORKERS=${WORKERS:-2}
      - THREADS=${THREADS:-4}

      # YOLO configuration
      - ALLOW_CUSTOM_MODEL_PATH=${ALLOW_CUSTOM_MODEL_PATH:-true}
      - DEBUG_PLOT=${DEBUG_PLOT:-false}
      - MODEL_SCORE_THRESHOLD=${MODEL_SCORE_THRESHOLD:-0.5}
      - MODEL_ROOT=/app/models

      # Hybrid mode configuration
      - USE_HYBRID_MODE=${USE_HYBRID_MODE:-false}
      - GROUNDING_DINO_CONFIG=${GROUNDING_DINO_CONFIG:-GroundingDINO_SwinT_OGC.py}
      - GROUNDING_DINO_WEIGHTS=${GROUNDING_DINO_WEIGHTS:-groundingdino_swint_ogc.pth}
      - GROUNDING_DINO_BOX_THRESHOLD=${GROUNDING_DINO_BOX_THRESHOLD:-0.3}
      - GROUNDING_DINO_TEXT_THRESHOLD=${GROUNDING_DINO_TEXT_THRESHOLD:-0.25}
      - GROUNDINGDINO_REPO_PATH=${GROUNDINGDINO_REPO_PATH:-./GroundingDINO}

      # System paths
      - MODEL_DIR=/data/models
      - PYTHONPATH=/app

    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "${PORT:-9090}:9090"
    volumes:
      - "./models:/app/models"
      - "./cache_dir:/app/cache_dir"
      - "./data:/data"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
